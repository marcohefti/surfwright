name: homebrew-tap-sync

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version without v prefix"
        required: true

permissions:
  contents: read

concurrency:
  group: homebrew-sync-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: 24

      - name: Resolve version and tarball metadata
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [[ -z "$VERSION" ]]; then
            echo "Unable to resolve version" >&2
            exit 1
          fi
          # New npm versions can take a short time to become visible on all registry edges.
          TARBALL=""
          for i in {1..20}; do
            CANDIDATE=$(npm view @marcohefti/surfwright@"$VERSION" dist.tarball --json 2>/dev/null | tr -d '"' || true)
            if [[ "$CANDIDATE" == http*://* ]]; then
              TARBALL="$CANDIDATE"
              break
            fi
            echo "Waiting for npm tarball metadata (attempt $i/20)..." >&2
            sleep 6
          done
          if [[ -z "$TARBALL" ]]; then
            echo "Unable to resolve npm tarball for @marcohefti/surfwright@$VERSION after retries" >&2
            exit 1
          fi
          curl -fsSL "$TARBALL" -o /tmp/surfwright.tgz
          SHA256=$(sha256sum /tmp/surfwright.tgz | awk '{print $1}')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tarball=$TARBALL" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          if [[ -z "${HOMEBREW_TAP_PAT}" ]]; then
            echo "Missing HOMEBREW_TAP_PAT secret" >&2
            exit 1
          fi
          git clone "https://x-access-token:${HOMEBREW_TAP_PAT}@github.com/marcohefti/homebrew-tap.git" /tmp/homebrew-tap

      - name: Update formula
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          TARBALL="${{ steps.meta.outputs.tarball }}"
          SHA256="${{ steps.meta.outputs.sha256 }}"
          cat > /tmp/homebrew-tap/Formula/surfwright.rb <<RUBY
          class Surfwright < Formula
            desc "Agent-first browser control surface for Chrome/Chromium"
            homepage "https://github.com/marcohefti/surfwright"
            url "${TARBALL}"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "node"

            def install
              system "npm", "install", *std_npm_args(prefix: libexec)
              bin.install_symlink Dir["#{libexec}/bin/*"]
            end

            test do
              assert_match "\"ok\":true", shell_output("#{bin}/surfwright contract")
            end
          end
          RUBY

      - name: Verify formula matches release version
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          grep -q "surfwright-${VERSION}.tgz" /tmp/homebrew-tap/Formula/surfwright.rb

      - name: Commit and push formula bump
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/surfwright.rb
          if git diff --cached --quiet; then
            echo "No formula changes to commit"
            exit 0
          fi
          git commit -m "chore(formula): surfwright ${{ steps.meta.outputs.version }}"
          git push origin main
