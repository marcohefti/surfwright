{"id":"F-001","severity":"high","category":"output-consistency","file":"src/features/extensions/register-commands.ts","line":11,"problem":"extension.* commands ignore global --no-json semantics and always emit JSON.","evidence":"JSON is always written in both branches at src/features/extensions/register-commands.ts:11-18; global semantics define --no-json as human output at src/cli.ts:148-150; extension manifests still advertise --no-json at src/features/extensions/manifest.ts:6,11,16,21; runtime probe: `node dist/cli.js --no-json extension list` returned JSON.","recommendation":"Make extension printers honor output.json=false with deterministic human summaries, or remove --no-json from extension manifests/docs if JSON-only is intended.","risk_if_ignored":"Cross-command output behavior remains inconsistent, increasing agent/operator branching and parse failures.","effort":"small"}
{"id":"F-002","severity":"medium","category":"contract-stability","file":"src/features/runtime/register-commands.ts","line":76,"problem":"`contract` accepts --compact, but contract schema for `contract` omits it.","evidence":"--compact is registered at src/features/runtime/register-commands.ts:76 and documented as retained alias at :88-89; runtime manifest usage omits it at src/features/runtime/manifest.ts:11; command flags are usage-derived at src/core/cli-contract.ts:175; runtime probes: `node dist/cli.js contract --compact` succeeds, while `node dist/cli.js contract --command contract` flags exclude --compact.","recommendation":"Either remove --compact entirely (clean-slate) or represent it explicitly in manifest/contract metadata (e.g., alias/deprecation fields) and tests.","risk_if_ignored":"Contract-first discovery is incomplete, so agents may reject valid commands or maintain ad-hoc exceptions.","effort":"small"}
{"id":"F-003","severity":"high","category":"typed-error-handling","file":"src/cli/options.ts","line":104,"problem":"Command-path parsing truncates/whitelists paths, so commander failure diagnostics lose validFlags/canonicalInvocation for several command families.","evidence":"Path depth capped at 2 and second token whitelisted to target/session/state/workspace at src/cli/options.ts:101-106; id resolution also only supports 1-2 segments at src/core/cli-contract.ts:37-40; diagnostics require contract lookup at src/cli/commander-failure.ts:24-31. Affected commands exist: extension.list (src/features/extensions/manifest.ts:11), update.check (src/features/runtime/manifest.ts:108), target.trace.insight (src/features/network/manifest.ts:70). Runtime probes with `--bogus` for extension/update/target trace lack diagnostics.validFlags while session.list includes them.","recommendation":"Replace parseCommandPath heuristics with full command-path resolution (Commander context or manifest trie supporting all roots and depth).","risk_if_ignored":"Typed failures become less actionable for agents/operators on invalid input, reducing fast recovery and increasing retries/manual lookup.","effort":"medium"}
{"id":"F-004","severity":"medium","category":"docs-contract-drift","file":"src/cli/argv-normalize.ts","line":118,"problem":"Compatibility argv rewrites add accepted grammar that is not encoded in command manifest usage/contract output.","evidence":"Legacy rewrites: --target alias at src/cli/argv-normalize.ts:118-208, session clear wrappers at :211-337, dot alias rewrite at :340-380; manifest usage omits these forms for target.snapshot and session.clear at src/features/target-core/manifest.ts:19 and src/features/runtime/manifest.ts:74; contract policy states contract-first/manifest truth at docs/architecture/contract-system.md:26-30 and :70-72; behavior is test-pinned at test/cli.contract.test.mjs:153-167 and test/dot-alias.contract.test.mjs:62-68.","recommendation":"Either remove compatibility rewrites (preferred clean-slate) or publish them in contract metadata and docs as explicit compat aliases with sunset policy.","risk_if_ignored":"Hidden surface area remains, creating drift between runtime behavior and contract-driven discovery.","effort":"medium"}
{"id":"F-005","severity":"medium","category":"typed-error-handling","file":"src/cli.ts","line":280,"problem":"Daemon queue typed failures are surfaced without retryable metadata.","evidence":"Error contracts mark queue codes retryable=true at src/core/contracts/error-contracts.ts:39-40; daemon error transport carries only code/message at src/core/daemon/infra/daemon-transport.ts:37-40 and src/core/daemon/infra/daemon.ts:416-420; CLI emits only ok/code/message for daemon typed errors at src/cli.ts:280-285; queue-routing tests assert code only at test/daemon/daemon.queue-routing.contract.test.mjs:164 and :193.","recommendation":"Include retryable in daemon error envelopes or map retryability from errorContracts before emitting CLI failure payload.","risk_if_ignored":"Agents cannot reliably distinguish transient queue pressure from non-retryable failures in daemon path.","effort":"medium"}
{"id":"F-006","severity":"medium","category":"contract-governance","file":"scripts/checks/contract-snapshot.mjs","line":80,"problem":"Contract snapshot/fingerprint governance does not cover typed-error message text drift.","evidence":"Error contracts include message at src/core/contracts/error-contracts.ts:3-70; fingerprint input excludes message in src/core/cli-contract.ts:355-357; snapshot normalization excludes message at scripts/checks/contract-snapshot.mjs:80-86; contract test only checks error codes at test/commands.contract.test.mjs:61-64.","recommendation":"If messages are contractual UX, include them in fingerprint/snapshot/tests; otherwise explicitly document messages as non-contractual.","risk_if_ignored":"Operator/agent remediation text can change silently without failing release gates.","effort":"small-medium"}
{"id":"F-007","severity":"low","category":"output-consistency","file":"src/cli.ts","line":157,"problem":"Commander parse failures emit human stderr plus JSON failure payload, creating dual-channel error output.","evidence":"Commander help/suggestions are enabled at src/cli.ts:157-159; JSON failure is printed in catch at src/cli.ts:189-193; runtime probe `node dist/cli.js target snapshot` emitted stderr human error and stdout JSON failure.","recommendation":"In JSON mode, suppress commander human stderr and keep a single machine envelope; preserve current behavior for --no-json.","risk_if_ignored":"Stream-merging wrappers can fail to parse deterministic machine output under invalid input.","effort":"medium"}
{"id":"F-008","severity":"high","category":"contract-stability","file":"src/core/daemon/app/worker-request-orchestrator.ts","line":89,"problem":"CLI can surface daemon internal error codes not present in published contract error list.","evidence":"Daemon worker emits E_DAEMON_TOKEN_INVALID/E_DAEMON_REQUEST_INVALID/E_DAEMON_RUN_FAILED at src/core/daemon/app/worker-request-orchestrator.ts:64,89,124,161,173 and src/core/daemon/infra/worker.ts:420; CLI forwards daemon typed errors directly at src/core/daemon/infra/daemon.ts:417-420 and src/cli.ts:279-285; published contract errors in src/core/contracts/error-contracts.ts:3-70 do not include these codes; runtime stub-daemon probe for `session list` returned code E_DAEMON_TOKEN_INVALID.","recommendation":"Map daemon transport-internal failures to published surface codes before emission, or include/document daemon internal codes in errorContracts and contract docs/tests.","risk_if_ignored":"contract.errors is incomplete relative to runtime behavior, so contract-first agents can mis-handle unadvertised failures.","effort":"medium"}
{"id":"F-009","severity":"high","category":"typed-error-handling","file":"src/cli.ts","line":58,"problem":"Flag parse validation errors are reported as E_INTERNAL instead of input/usage failure code.","evidence":"parseTimeoutMs throws plain Error at src/cli.ts:58-67; parseLeaseTtlMs throws plain Error at src/features/runtime/register-commands.ts:48-53; generic Error maps to E_INTERNAL in src/core/errors.ts:107-113; parsers are bound to user options at src/features/runtime/register-commands.ts:247 and 268; runtime probes: `session ensure --timeout-ms abc` and `session new --lease-ttl-ms foo` both return code E_INTERNAL.","recommendation":"Throw CliError(E_QUERY_INVALID, ...) from option parsers or normalize parser exceptions at command boundary to preserve query-invalid classification.","risk_if_ignored":"Operator input mistakes appear as internal faults, weakening retry routing, telemetry quality, and user guidance.","effort":"small"}
{"id":"F-010","severity":"medium","category":"contract-governance","file":"src/features/runtime/contract-output.ts","line":99,"problem":"Compact contract list ordering is not pinned by fingerprint/snapshot gates.","evidence":"compact commandIds/errorCodes preserve report order at src/features/runtime/contract-output.ts:99-100; report order follows plugin/manifest declaration order at src/features/registry.ts:99-101; fingerprint sorts commands/errors before hashing at src/core/cli-contract.ts:352-357; snapshot check also sorts before compare at scripts/checks/contract-snapshot.mjs:70-87.","recommendation":"Either declare ordering non-contractual or sort compact commandIds/errorCodes and add explicit order assertions in tests.","risk_if_ignored":"Refactor-only ordering changes can alter compact payloads without triggering release contract gates.","effort":"small"}
