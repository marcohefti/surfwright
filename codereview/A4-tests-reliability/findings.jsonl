{"id":"A4-TR-001","severity":"high","category":"fixture-discipline","file":"test/ingress.fixture-replay.test.mjs","line":211,"problem":"Ingress fixture lane validates static fixture JSON fields but does not execute runtime command replay.","evidence":"Fixture data is read from disk (lines 32-35), command-specific checks compare fixture.observed to fixture.expect (lines 56-190), and the test loop validates files only (lines 211-263). Workflow doc requires integration replay (docs/fixture-ingress-workflow.md:76).","recommendation":"Add runtime fixture replay test(s) that execute fixture.command.input through CLI/test harness and compare normalized output to fixture.expect.","risk_if_ignored":"Command behavior regressions can pass fixture lane undetected.","effort":"M"}
{"id":"A4-TR-002","severity":"high","category":"flaky-risk","file":"test/browser/target/effects/target.effects.browser.mjs","line":42,"problem":"Browser contract test retries failures for broad error codes, including internal/timeout classes, masking first-attempt instability.","evidence":"Retryable set includes E_INTERNAL and E_WAIT_TIMEOUT (lines 42-48); failed open is retried once when code matches (lines 53-59), with explicit comment about flaky infra races (line 57).","recommendation":"Remove broad automatic retry from contract tests; if retained for diagnostics, preserve and fail on first-attempt failure while recording second-attempt metadata separately.","risk_if_ignored":"Intermittent regressions can be hidden and CI signal becomes less trustworthy.","effort":"S"}
{"id":"A4-TR-003","severity":"medium","category":"release-gating","file":".github/workflows/release-draft.yml","line":50,"problem":"Release-draft verification uses pnpm test, but pnpm test excludes browser lane.","evidence":"release-draft runs pnpm validate/pnpm test/pnpm skill:validate (lines 50-52). package.json test script excludes test:browser (line 47) while test:browser exists separately (line 42). CI test job runs browser lane explicitly (ci.yml:186-189).","recommendation":"Run pnpm -s test:browser in release-draft verification or redefine pnpm test to include browser lane and provide a fast local subset script separately.","risk_if_ignored":"Release candidate checks can miss browser-regression failures.","effort":"S"}
{"id":"A4-TR-004","severity":"medium","category":"policy-coverage","file":"test/policy/no-skips.contract.test.mjs","line":12,"problem":"Skip-marker policy excludes browser tests, so skipped browser tests are not structurally prevented.","evidence":"Directory browser is excluded from traversal (lines 12-14); scan targets only .contract.test.mjs files (lines 21-27).","recommendation":"Add browser-lane no-skip policy check for test/browser/**/*.browser.mjs, including test.skip/describe.skip/it.skip and skip-option markers.","risk_if_ignored":"Browser coverage can erode silently via skipped tests.","effort":"S"}
{"id":"A4-TR-005","severity":"medium","category":"contract-test-quality","file":"test/commands.contract.test.mjs","line":55,"problem":"Command-surface contract test checks only command presence and usage substring; behavior/flag semantics remain unverified for many listed commands.","evidence":"Loop verifies only missing command and usage contains (lines 55-59). Fixture lists include broad command surface (commands.core.json lines 4-7,30,44-46,48,50-51,59-60; commands.network.json lines 7,9,12,14; commands.experimental.json line 2). Coverage scan found no direct invocations for 17 listed IDs (workspace.info, workspace.init, workspace.profile-lock-clear, target.read, target.console-tail, target.health, target.hud, extension.load, extension.reload, extension.uninstall, skill.doctor, skill.update, target.network-export-prune, target.network-begin, target.trace.export, target.network-check, exp.effects).","recommendation":"Generate and enforce a command smoke matrix from contract fixtures with one minimal typed assertion per command ID.","risk_if_ignored":"Behavior regressions can slip while contract surface tests still pass.","effort":"M"}
{"id":"A4-TR-006","severity":"medium","category":"test-runtime-guard","file":"test/cli.contract.test.mjs","line":11,"problem":"Many contract tests spawn CLI without local subprocess timeouts, increasing hang risk.","evidence":"spawnSync in cli.contract has no timeout (lines 10-17); same pattern exists in commands.contract (10-17), pipeline.contract (10-17,20-28), and session.clear contract (11-18). Browser helper already enforces timeout discipline (test/browser/helpers/cli-runner.mjs:4-6,69-83).","recommendation":"Create shared contract CLI runner with default timeout/kill policy and migrate contract tests to it.","risk_if_ignored":"Stuck subprocesses can stall local runs and consume CI job timeout budget.","effort":"M"}
{"id":"A4-TR-007","severity":"low","category":"docs-consistency","file":"docs/fixture-ingress-workflow.md","line":41,"problem":"Fixture workflow example omits observed payload while tests require observed to exist.","evidence":"Doc JSON example includes schemaVersion/caseId/source/command/expect only (lines 41-67), but fixture replay asserts fixture.observed object (test/ingress.fixture-replay.test.mjs:52).","recommendation":"Align docs with enforced schema by documenting observed as required (or relax test requirement if optional by design).","risk_if_ignored":"Contributor confusion and avoidable fixture PR rework.","effort":"S"}
{"id":"A4-TR-008","severity":"medium","category":"scalability","file":"package.json","line":41,"problem":"Contract and browser lanes are forced to single concurrency, limiting suite scaling.","evidence":"test:contract uses --test-concurrency=1 (package.json:41). Browser runner also launches node --test with --test-concurrency=1 (scripts/tests/run-browser-tests.mjs:101-104).","recommendation":"After isolating test state, shard by subsystem and raise concurrency gradually with reliability guards.","risk_if_ignored":"Feedback loops and CI times will scale linearly as tests grow.","effort":"M"}
{"id":"A4-TR-009","severity":"medium","category":"isolation","file":"test/browser/core/cli.browser.mjs","line":9,"problem":"Browser test files share one mutable state dir per file and clean only at file end, increasing order-coupling risk.","evidence":"Single TEST_STATE_DIR and runner are file-global (lines 9-10), cleanup happens in test.after only (lines 42-44), and tests mutate shared state.json directly (lines 49-75). Similar shared-state pattern exists in test/browser/core/commands.browser.mjs:9-13.","recommendation":"Create per-test state dirs (beforeEach/afterEach) or a deterministic state reset helper between tests.","risk_if_ignored":"Parallelization becomes fragile and hidden inter-test dependencies can cause flaky behavior.","effort":"M"}
{"id":"A4-TR-010","severity":"medium","category":"maintainability","file":"test/ingress.fixture-replay.test.mjs","line":223,"problem":"Ingress fixture validation relies on a monolithic command-id dispatch chain that requires central edits for each new command fixture.","evidence":"The replay loop branches via repeated if(command.id===...) checks with a hard fail for unsupported commands (lines 223-259).","recommendation":"Refactor to a validator registry map keyed by command id with modular validators to reduce merge conflicts and growth friction.","risk_if_ignored":"Fixture expansion will increase PR conflicts and slow onboarding for new regression cases.","effort":"S"}
{"id":"A4-TR-011","severity":"low","category":"fixture-discipline","file":"test/fixtures/ingress/target.click/basic-selector-click.json","line":22,"problem":"Fixtures keep volatile observed fields (ids/timing) despite workflow guidance to remove volatile details.","evidence":"Workflow says remove volatile details (docs/fixture-ingress-workflow.md:74). Example fixture includes actionId and timingMs fields (target.click fixture lines 22,39-44) and ephemeral target ids (target.list fixture lines 20-33).","recommendation":"Add fixture normalization/redaction tooling and enforce minimal invariant observed payloads.","risk_if_ignored":"Fixture noise and accidental coupling to ephemeral values increase maintenance cost.","effort":"S"}
{"id":"A4-TR-012","severity":"low","category":"diagnostics","file":".github/workflows/ci.yml","line":186,"problem":"CI test artifacts capture only a final summary line, not per-lane logs.","evidence":"Test step runs contract/fixtures/browser lanes (lines 186-188) and writes only an echo line to artifacts/test/test.log (line 189); upload step publishes only that file (lines 191-196).","recommendation":"Tee each lane to dedicated artifact logs and upload all logs for deterministic post-failure triage.","risk_if_ignored":"Failure diagnosis from artifacts is weaker and slower.","effort":"S"}
{"id":"A4-TR-013","severity":"medium","category":"coverage-gap","file":"package.json","line":11,"problem":"No explicit coverage instrumentation or threshold gate is defined in scripts/CI test flow.","evidence":"Scripts list has test lanes but no coverage command in package.json lines 11-51; CI test job executes test lanes directly without coverage step (ci.yml:182-189).","recommendation":"Add coverage collection/reporting and enforce minimum thresholds (global + changed-files guard).","risk_if_ignored":"Coverage blind spots can grow without objective detection.","effort":"M"}
