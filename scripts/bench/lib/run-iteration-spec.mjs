import path from "node:path";

function yamlQuote(value) {
  return `'${String(value).replace(/'/g, "''")}'`;
}

function yamlInlineArray(values) {
  return `[${values.map((v) => yamlQuote(v)).join(", ")}]`;
}

export function buildCampaignSpec({
  config,
  loopId,
  campaignId,
  missionIds,
  outRoot,
  repoRoot,
  reportDir,
  shimDir,
  pathValue,
  surfwrightRealBin,
}) {
  const promptsPath = path.resolve(repoRoot, "missions/browser-control/prompts");
  const oraclesPath = path.resolve(repoRoot, "missions/browser-control/oracles");
  const evaluatorPath = path.resolve(repoRoot, "scripts/zcl/eval-browser-control-oracle.mjs");
  const missionLines = missionIds.map((id) => `      - ${id}`).join("\n");

  return [
    "schemaVersion: 1",
    `campaignId: ${campaignId}`,
    `outRoot: ${yamlQuote(outRoot)}`,
    "promptMode: exam",
    "",
    `totalMissions: ${missionIds.length}`,
    `canaryMissions: ${Math.min(2, missionIds.length)}`,
    "failFast: false",
    "",
    "missionSource:",
    "  promptSource:",
    `    path: ${yamlQuote(promptsPath)}`,
    "  oracleSource:",
    `    path: ${yamlQuote(oraclesPath)}`,
    "    visibility: workspace",
    "  selection:",
    "    mode: mission_id",
    "    missionIds:",
    missionLines,
    "",
    "evaluation:",
    "  mode: oracle",
    "  evaluator:",
    "    kind: script",
    `    command: ${yamlInlineArray(["node", evaluatorPath])}`,
    "",
    "execution:",
    "  flowMode: sequence",
    "",
    "pairGate:",
    "  enabled: true",
    "  stopOnFirstMissionFailure: false",
    "  traceProfile: none",
    "",
    "timeouts:",
    `  campaignGlobalTimeoutMs: ${config.campaignGlobalTimeoutMs}`,
    `  defaultAttemptTimeoutMs: ${config.attemptTimeoutMs}`,
    "  cleanupHookTimeoutMs: 10000",
    "  timeoutStart: first_tool_call",
    "",
    "output:",
    `  reportPath: ${yamlQuote(path.join(reportDir, "campaign.report.json"))}`,
    `  summaryPath: ${yamlQuote(path.join(reportDir, "campaign.summary.json"))}`,
    `  resultsMdPath: ${yamlQuote(path.join(reportDir, "RESULTS.md"))}`,
    `  progressJsonl: ${yamlQuote(path.join(reportDir, "campaign.progress.jsonl"))}`,
    "",
    "flows:",
    "  - flowId: surfwright",
    "    runner:",
    "      type: codex_app_server",
    "      sessionIsolation: native",
    "      runtimeStrategies: ['codex_app_server']",
    `      model: ${config.model}`,
    `      modelReasoningEffort: ${config.reasoningEffort}`,
    `      modelReasoningPolicy: ${config.reasoningPolicy}`,
    "      feedbackPolicy: strict",
    "      mode: discovery",
    `      freshAgentPerAttempt: ${config.freshAgentPerAttempt ? "true" : "false"}`,
    "      toolDriver:",
    "        kind: mcp_proxy",
    "      finalization:",
    "        mode: auto_from_result_json",
    "        minResultTurn: 3",
    "        resultChannel:",
    "          kind: file_json",
    "          path: mission.result.json",
    "      mcp:",
    `        maxToolCalls: ${config.mcpMaxToolCalls}`,
    `        idleTimeoutMs: ${config.mcpIdleTimeoutMs}`,
    "        shutdownOnComplete: true",
    "      env:",
    "        ZCL_BROWSER_SURFACE: surfwright",
    "        ZCL_NATIVE_MAX_INFLIGHT_PER_STRATEGY: '6'",
    "        ZCL_NATIVE_MIN_START_INTERVAL_MS: '150'",
    `        ZCL_BENCH_SURFWRIGHT_REAL_BIN: ${yamlQuote(surfwrightRealBin)}`,
    `        ZCL_BENCH_SURFWRIGHT_SHIM_DIR: ${yamlQuote(shimDir)}`,
    `        PATH: ${yamlQuote(pathValue)}`,
    "",
    `# loopId: ${loopId}`,
  ].join("\n");
}
